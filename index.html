<!DOCTYPE html>
<html lang="hu">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Irodai Esem√©ny R√∂gz√≠t≈ë (v2)</title>
    <!-- Tailwind CSS bet√∂lt√©se -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js (Grafikon k√∂nyvt√°r) bet√∂lt√©se -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- jsPDF (PDF gener√°l√≥) √©s html2canvas (HTML "f√©nyk√©pez≈ë") -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <!-- Supabase kliens bet√∂lt√©se -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        /* Egyedi "Inter" bet≈±t√≠pus haszn√°lata */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
        }

        .btn-press-feedback {
            transform: scale(0.95);
            opacity: 0.7;
            transition: all 0.1s ease-out;
        }

        #loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* Gomb st√≠lus a v√°rosv√°laszt√≥hoz */
        .city-btn {
            transition: all 0.2s ease-in-out;
        }

        .city-btn:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        /* Polling indicator */
        .polling-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-left: 8px;
            transition: all 0.3s ease;
        }

        .polling-active {
            background-color: #10b981;
            box-shadow: 0 0 8px rgba(16, 185, 129, 0.6);
            animation: pulse 2s infinite;
        }

        .polling-inactive {
            background-color: #ef4444;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }

        /* K√âR√âS: V√°ros-specifikus k√°rtya szeg√©ly */
        #main-card.border-gyor {
            border: 1px solid #22c55e;
        }

        /* green-500 */
        #main-card.border-kaposvar {
            border: 1px solid #3b82f6;
        }

        /* blue-500 */
        #main-card.border-pecs {
            border: 1px solid #a855f7;
        }

        /* purple-500 */
    </style>
</head>

<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">

    <!-- K√âR√âS: ID hozz√°adva a f≈ë k√°rty√°hoz -->
    <div id="main-card" class="w-full max-w-4xl bg-white rounded-2xl shadow-xl p-6 md:p-10">

        <!-- √öJ N√âZET: V√ÅROS V√ÅLASZT√ì -->
        <div id="city-selection-view">
            <h1 class="text-3xl font-bold text-center text-gray-800 mb-8">V√°lassz v√°rost</h1>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <button data-city="gyor"
                    class="city-btn bg-gradient-to-r from-green-500 to-green-600 text-white p-8 rounded-xl shadow-lg">
                    <span class="text-2xl font-semibold">Gy≈ër</span>
                </button>
                <button data-city="kaposvar"
                    class="city-btn bg-gradient-to-r from-blue-500 to-blue-600 text-white p-8 rounded-xl shadow-lg">
                    <span class="text-2xl font-semibold">Kaposv√°r</span>
                </button>
                <button data-city="pecs"
                    class="city-btn bg-gradient-to-r from-purple-500 to-purple-600 text-white p-8 rounded-xl shadow-lg">
                    <span class="text-2xl font-semibold">P√©cs</span>
                </button>
            </div>
        </div>

        <!-- 1. N√âZET: FELHASZN√ÅL√ìI FEL√úLET (R√ñGZ√çT√âS) -->
        <div id="user-view" class="hidden">
            <!-- Bet√∂lt√©sjelz≈ë (most m√°r a user-view-n bel√ºl van) -->
            <div id="loading-overlay" class="text-center py-20">
                <div id="loading-spinner" class="mx-auto mb-4"></div>
                <p class="text-lg font-semibold text-gray-600">Csatlakoz√°s az adatb√°zishoz...</p>
                <p id="loading-city-name" class="text-md text-gray-500 mt-2"></p>
            </div>

            <!-- A t√©nyleges tartalom, alapb√≥l rejtve -->
            <div id="user-content" class="hidden">
                <div class="flex justify-between items-center mb-8">
                    <h1 class="text-3xl font-bold text-gray-800">Esem√©ny R√∂gz√≠t√©se</h1>
                    <!-- V√°ros √©s v√°lt√°s gomb -->
                    <div class="flex items-center">
                        <span id="current-city-display" class="text-lg font-semibold text-gray-700"></span>
                        <span id="polling-indicator" class="polling-indicator polling-inactive"
                            title="Szinkroniz√°ci√≥ √°llapota"></span>
                        <button id="change-city-btn"
                            class="ml-3 text-sm text-blue-600 hover:underline">(V√°lt√°s)</button>
                    </div>
                </div>

                <!-- Utols√≥ friss√≠t√©s id≈ëpontja -->
                <div class="text-center mb-2">
                    <p id="last-sync-time" class="text-xs text-gray-500"></p>
                </div>

                <!-- FEJLESZT√âS: Visszajelz≈ë √ºzenet (poz√≠ci√≥) -->
                <div class="relative h-6 mb-4">
                    <div id="feedback-message"
                        class="absolute inset-0 text-center font-semibold transition-opacity duration-300 opacity-0">
                    </div>
                </div>

                <!-- Gombok r√°csban -->
                <div id="task-buttons" class="grid grid-cols-2 lg:grid-cols-3 gap-4 md:gap-6">
                    <!-- Task 1 -->
                    <button data-task-type="ujmegrendeles"
                        class="task-btn relative bg-blue-600 text-white p-6 rounded-xl shadow-lg hover:bg-blue-700 focus:outline-none focus:ring-4 focus:ring-blue-300 transition-all duration-200 transform hover:scale-105">
                        <span class="text-lg font-semibold">√öj megrendel√©s</span>
                        <span
                            class="task-counter absolute -top-2 -right-2 bg-red-500 text-white text-xs font-bold rounded-full h-6 w-6 flex items-center justify-center border-2 border-white hidden">0</span>
                    </button>
                    <!-- Task 2 -->
                    <button data-task-type="huseghosszabbitas"
                        class="task-btn relative bg-sky-600 text-white p-6 rounded-xl shadow-lg hover:bg-sky-700 focus:outline-none focus:ring-4 focus:ring-sky-300 transition-all duration-200 transform hover:scale-105">
                        <span class="text-lg font-semibold">H≈±s√©ghosszabb√≠t√°s / Csomagv√°lt√°s</span>
                        <span
                            class="task-counter absolute -top-2 -right-2 bg-red-500 text-white text-xs font-bold rounded-full h-6 w-6 flex items-center justify-center border-2 border-white hidden">0</span>
                    </button>
                    <!-- Task 3 -->
                    <button data-task-type="hibabejelentes"
                        class="task-btn relative bg-red-600 text-white p-6 rounded-xl shadow-lg hover:bg-red-700 focus:outline-none focus:ring-4 focus:ring-red-300 transition-all duration-200 transform hover:scale-105">
                        <span class="text-lg font-semibold">Hibabejelent√©s</span>
                        <span
                            class="task-counter absolute -top-2 -right-2 bg-red-500 text-white text-xs font-bold rounded-full h-6 w-6 flex items-center justify-center border-2 border-white hidden">0</span>
                    </button>
                    <!-- Task 4 -->
                    <button data-task-type="erdeklodes"
                        class="task-btn relative bg-yellow-500 text-white p-6 rounded-xl shadow-lg hover:bg-yellow-600 focus:outline-none focus:ring-4 focus:ring-yellow-300 transition-all duration-200 transform hover:scale-105">
                        <span class="text-lg font-semibold">√ârdekl≈ëd√©s</span>
                        <span
                            class="task-counter absolute -top-2 -right-2 bg-red-500 text-white text-xs font-bold rounded-full h-6 w-6 flex items-center justify-center border-2 border-white hidden">0</span>
                    </button>
                    <!-- Task 5 -->
                    <button data-task-type="eszkozleadas"
                        class="task-btn relative bg-gray-600 text-white p-6 rounded-xl shadow-lg hover:bg-gray-700 focus:outline-none focus:ring-4 focus:ring-gray-300 transition-all duration-200 transform hover:scale-105">
                        <span class="text-lg font-semibold">Eszk√∂zlead√°s</span>
                        <span
                            class="task-counter absolute -top-2 -right-2 bg-red-500 text-white text-xs font-bold rounded-full h-6 w-6 flex items-center justify-center border-2 border-white hidden">0</span>
                    </button>
                    <!-- Task 6 -->
                    <button data-task-type="lemondas"
                        class="task-btn relative bg-purple-600 text-white p-6 rounded-xl shadow-lg hover:bg-purple-700 focus:outline-none focus:ring-4 focus:ring-purple-300 transition-all duration-200 transform hover:scale-105">
                        <span class="text-lg font-semibold">Lemond√°s</span>
                        <span
                            class="task-counter absolute -top-2 -right-2 bg-red-500 text-white text-xs font-bold rounded-full h-6 w-6 flex items-center justify-center border-2 border-white hidden">0</span>
                    </button>

                    <!-- √öJ GOMB (Task 7) -->
                    <!-- M√ìDOS√çT√ÅS: 'lg:col-start-2' hozz√°adva a PC-n√©zetes k√∂z√©pre igaz√≠t√°shoz -->
                    <button data-task-type="szamlabefizetes"
                        class="task-btn relative bg-green-600 text-white p-6 rounded-xl shadow-lg hover:bg-green-700 focus:outline-none focus:ring-4 focus:ring-green-300 transition-all duration-200 transform hover:scale-105 lg:col-start-2">
                        <span class="text-lg font-semibold">Sz√°mlabefizet√©s</span>
                        <span
                            class="task-counter absolute -top-2 -right-2 bg-red-500 text-white text-xs font-bold rounded-full h-6 w-6 flex items-center justify-center border-2 border-white hidden">0</span>
                    </button>
                </div>

                <!-- FEJLESZT√âS: Offline v√°r√≥lista jelz≈ë -->
                <div id="offline-queue-indicator" class="text-center mt-4 text-sm text-yellow-700 font-medium hidden">
                    <span id="offline-queue-count">0</span> nem szinkroniz√°lt esem√©ny. Kapcsol√≥d√°s...
                </div>

                <!-- Admin n√©zet gomb -->
                <div class="text-center mt-12">
                    <button id="show-admin-btn"
                        class="text-gray-600 hover:text-blue-600 font-semibold py-2 px-4 rounded-lg transition-colors duration-200">
                        - Admin N√©zet -
                    </button>
                </div>
            </div>
        </div>

        <!-- 2. N√âZET: ADMIN FEL√úLET (STATISZTIKA) -->
        <div id="admin-view" class="hidden">
            <!-- M√ìDOS√çT√ÅS: Fejl√©c kont√©ner a vissza gombhoz √©s a c√≠mhez -->
            <div class="relative mb-4">
                <button id="back-to-user-btn-top"
                    class="absolute top-0 left-0 flex items-center text-sm text-blue-600 hover:text-blue-800 hover:underline p-2 rounded-lg group z-10">
                    <!-- Be√°gyazott SVG ny√≠l -->
                    <svg class="w-5 h-5 mr-1 group-hover:-translate-x-1 transition-transform duration-200" fill="none"
                        stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                    </svg>
                    <span>Vissza a r√∂gz√≠t√©shez</span>
                </button>
                <h1 class="text-3xl font-bold text-center text-gray-800 pt-2">Admin Statisztika</h1>
            </div>

            <!-- √öJ: V√°rosv√°laszt√≥ filter -->
            <div class="mb-6 max-w-xs mx-auto">
                <label for="admin-city-filter" class="block text-sm font-medium text-gray-700 mb-1 text-center">V√°ros
                    sz≈±r≈ë</label>
                <select id="admin-city-filter"
                    class="w-full p-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500">
                    <option value="gyor">Gy≈ër</option>
                    <option value="kaposvar">Kaposv√°r</option>
                    <option value="pecs">P√©cs</option>
                    <option value="osszesitve">√ñsszes√≠tve</option>
                </select>
            </div>

            <!-- Id≈ëszak v√°laszt√≥ f√ºlek -->
            <div class="flex justify-center space-x-2 mb-6 border-b-2 border-gray-200">
                <button data-period="daily"
                    class="period-btn px-6 py-3 font-semibold text-gray-500 border-b-4 border-transparent hover:text-blue-600">Napi</button>
                <button data-period="weekly"
                    class="period-btn px-6 py-3 font-semibold text-gray-500 border-b-4 border-transparent hover:text-blue-600">Heti</button>
                <button data-period="monthly"
                    class="period-btn px-6 py-3 font-semibold text-gray-500 border-b-4 border-transparent hover:text-blue-600">Havi</button>
                <button data-period="custom"
                    class="period-btn px-6 py-3 font-semibold text-gray-500 border-b-4 border-transparent hover:text-blue-600">Egy√©ni</button>
            </div>

            <!-- √öJ: Egy√©ni d√°tum v√°laszt√≥ (Alapb√≥l rejtve) -->
            <div id="custom-date-range"
                class="hidden mb-6 bg-gray-50 p-4 rounded-lg border border-gray-200 text-center">
                <h4 class="text-sm font-semibold text-gray-700 mb-3">V√°lassz id≈ëszakot</h4>
                <div class="flex flex-col sm:flex-row gap-3 justify-center items-center">
                    <div class="flex flex-col text-left">
                        <label for="custom-start-date" class="text-xs text-gray-500 mb-1">Kezd≈ë d√°tum</label>
                        <input type="date" id="custom-start-date"
                            class="p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div class="flex flex-col text-left">
                        <label for="custom-end-date" class="text-xs text-gray-500 mb-1">Z√°r√≥ d√°tum</label>
                        <input type="date" id="custom-end-date"
                            class="p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <button id="custom-query-btn"
                        class="mt-4 sm:mt-0 sm:ml-2 bg-blue-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-blue-700 transition-colors duration-200 h-[42px] self-end">
                        Lek√©rdez√©s
                    </button>
                </div>
                <p id="custom-date-error" class="text-red-500 text-sm mt-2 hidden"></p>
            </div>

            <!-- Bet√∂lt√©sjelz≈ë az admin panelen -->
            <div id="admin-loading" class="text-center py-10 hidden">
                <div id="loading-spinner" class="mx-auto mb-4"></div>
                <p class="text-lg font-semibold text-gray-600">Adatok lek√©rdez√©se...</p>
            </div>

            <!-- Riport tartalma -->
            <div id="admin-report-area" class="w-full max-w-6xl mx-auto">
                <h3 id="report-title" class="text-2xl font-bold text-center text-gray-800 mb-8"></h3>

                <!-- DASHBOARD GRID -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8">

                    <!-- 1. Bal oszlop: T√°bl√°zat -->
                    <div id="report-content" class="overflow-x-auto"></div>


                    <!-- 2. Jobb oszlop: Eloszl√°s (F√°nk) - M√ìDOS√çT√ÅS: justify-start (k√∂z√©p helyett), p-3 -->
                    <div
                        class="bg-white rounded-lg shadow-md border border-gray-200 p-3 flex flex-col items-center justify-start">
                        <h4 class="text-sm font-semibold text-gray-700 mb-2">Tev√©kenys√©g Megoszl√°s</h4>
                        <div class="w-full max-w-xs h-[200px]"> <!-- M√ìDOS√çT√ÅS: Kisebb fix magass√°g -->
                            <canvas id="distribution-chart"></canvas>
                        </div>
                    </div>

                    <!-- 3. Teljes sz√©less√©g: √ñsszes√≠tett Oszlop (Megl√©v≈ë) -->
                    <div class="md:col-span-2 bg-white rounded-lg shadow-md border border-gray-200 p-6">
                        <h4 class="text-lg font-semibold text-gray-700 mb-4 text-center">√ñsszes√≠tett Darabsz√°mok</h4>
                        <div class="w-full h-80">
                            <canvas id="report-chart"></canvas>
                        </div>
                    </div>

                    <!-- 4. Teljes sz√©less√©g: Trend (Vonal) -->
                    <div class="md:col-span-2 bg-white rounded-lg shadow-md border border-gray-200 p-6">
                        <h4 class="text-lg font-semibold text-gray-700 mb-4 text-center">Napi Trendek</h4>
                        <div class="w-full h-80">
                            <canvas id="trend-chart"></canvas>
                        </div>
                    </div>

                    <!-- 5. Teljes sz√©less√©g: V√°ros √∂sszehasonl√≠t√°s (Csoportos√≠tott) -->
                    <div class="md:col-span-2 bg-white rounded-lg shadow-md border border-gray-200 p-6">
                        <h4 class="text-lg font-semibold text-gray-700 mb-4 text-center">V√°rosok √ñsszehasonl√≠t√°sa</h4>
                        <div class="w-full h-80">
                            <canvas id="comparison-chart"></canvas>
                        </div>
                    </div>

                </div>
            </div>

            <!-- √öJ: Nap T√∂rl√©se Szekci√≥ (csak Napi n√©zetben) -->
            <div id="delete-day-section"
                class="mt-10 p-6 bg-red-50 border-2 border-red-200 rounded-lg max-w-2xl mx-auto hidden">
                <h4 class="text-lg font-semibold text-red-800 mb-3 text-center">Nap T√∂rl√©se</h4>
                <p id="delete-warning-message" class="text-sm text-center text-red-700 mb-4">
                    Figyelem: Ez a m≈±velet v√©glegesen t√∂rli a kiv√°lasztott nap adatait!
                </p>
                <div class="flex flex-col sm:flex-row gap-4 justify-center items-center">
                    <input type="date" id="delete-date-input" class="p-2 border border-gray-300 rounded-lg">
                    <button id="delete-day-btn"
                        class="bg-red-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-red-700 transition-colors duration-200 disabled:opacity-50 disabled:cursor-not-allowed">
                        T√∂rl√©s
                    </button>
                </div>
                <div id="delete-feedback" class="text-center h-4 mt-3 text-sm font-medium"></div>
            </div>

            <!-- PDF Export gomb -->
            <div class="text-center mt-8">
                <button id="download-pdf-btn"
                    class="bg-green-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-green-700 transition-colors duration-200">
                    Riport PDF Let√∂lt√©se
                </button>
                <div id="pdf-loading-message" class="text-gray-600 h-4 mt-2 text-sm"></div>
            </div>

            <!-- Vissza gomb -->
            <div class="text-center mt-6">
                <button id="back-to-user-btn"
                    class="bg-gray-700 text-white font-semibold py-2 px-6 rounded-lg hover:bg-gray-800 transition-colors duration-200">
                    Vissza a r√∂gz√≠t√©shez
                </button>
            </div>
        </div>
    </div>

    <script type="module">
        // === UI ELEMEK ===
        const mainCard = document.getElementById('main-card'); // K√âR√âS: F≈ë k√°rtya
        const citySelectionView = document.getElementById('city-selection-view');
        const userView = document.getElementById('user-view');
        const adminView = document.getElementById('admin-view');
        const loadingOverlay = document.getElementById('loading-overlay');
        const loadingCityName = document.getElementById('loading-city-name');
        const userContent = document.getElementById('user-content');
        const currentCityDisplay = document.getElementById('current-city-display');
        const changeCityBtn = document.getElementById('change-city-btn');
        const adminLoading = document.getElementById('admin-loading');
        const showAdminBtn = document.getElementById('show-admin-btn');
        const backToUserBtn = document.getElementById('back-to-user-btn');
        const backToUserBtnTop = document.getElementById('back-to-user-btn-top'); // √öJ
        const taskButtonsContainer = document.getElementById('task-buttons');
        const feedbackMessage = document.getElementById('feedback-message');
        const reportContent = document.getElementById('report-content');
        const reportTitle = document.getElementById('report-title');
        const periodButtons = document.querySelectorAll('.period-btn');
        const reportChartCanvas = document.getElementById('report-chart');
        let reportChartInstance = null;

        // √öJ CHARTOK
        const trendChartCanvas = document.getElementById('trend-chart');
        let trendChartInstance = null;
        const distributionChartCanvas = document.getElementById('distribution-chart');
        let distributionChartInstance = null;
        const comparisonChartCanvas = document.getElementById('comparison-chart');
        let comparisonChartInstance = null;

        const downloadPdfBtn = document.getElementById('download-pdf-btn');
        const pdfLoadingMessage = document.getElementById('pdf-loading-message');
        const pollingIndicator = document.getElementById('polling-indicator');
        const lastSyncTime = document.getElementById('last-sync-time');

        // Admin filter
        const adminCityFilter = document.getElementById('admin-city-filter');

        // Delete section
        const deleteDaySection = document.getElementById('delete-day-section');
        const deleteDateInput = document.getElementById('delete-date-input');
        const deleteDayBtn = document.getElementById('delete-day-btn');
        const deleteFeedback = document.getElementById('delete-feedback');
        const deleteWarningMessage = document.getElementById('delete-warning-message');

        // √öJ: Custom Date Elements
        const customDateRange = document.getElementById('custom-date-range');
        const customStartDate = document.getElementById('custom-start-date');
        const customEndDate = document.getElementById('custom-end-date');
        const customQueryBtn = document.getElementById('custom-query-btn');
        const customDateError = document.getElementById('custom-date-error');

        // FEJLESZT√âS: Offline Queue UI
        const offlineQueueIndicator = document.getElementById('offline-queue-indicator');
        const offlineQueueCount = document.getElementById('offline-queue-count');

        // === ALAP KONFIGUR√ÅCI√ì ===
        // --- M√ìDOS√çT√ÅS KEZDETE ---
        const TASK_NAMES = {
            ujmegrendeles: "√öj megrendel√©s",
            huseghosszabbitas: "H≈±s√©ghosszabb√≠t√°s/csomagv√°lt√°s",
            hibabejelentes: "Hibabejelent√©s",
            erdeklodes: "√ârdekl≈ëd√©s",
            eszkozleadas: "Eszk√∂zlead√°s",
            lemondas: "Lemond√°s",
            szamlabefizetes: "Sz√°mlabefizet√©s" // √öJ
        };
        // --- M√ìDOS√çT√ÅS V√âGE ---

        const CITY_NAMES = {
            gyor: "Gy≈ër",
            kaposvar: "Kaposv√°r",
            pecs: "P√©cs",
            osszesitve: "√ñsszes√≠tve"
        };

        // --- M√ìDOS√çT√ÅS KEZDETE ---
        const createEmptyDayData = () => ({
            ujmegrendeles: 0, huseghosszabbitas: 0, hibabejelentes: 0,
            erdeklodes: 0, eszkozleadas: 0, lemondas: 0,
            szamlabefizetes: 0 // √öJ
        });
        // --- M√ìDOS√çT√ÅS V√âGE ---

        let todayData = createEmptyDayData();

        // === SUPABASE INICIALIZ√ÅL√ÅS ===
        const SUPABASE_URL = 'https://kqsxwnrlelufjdgsfryr.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imtxc3h3bnJsZWx1ZmpkZ3NmcnlyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMxMDc1NzMsImV4cCI6MjA3ODY4MzU3M30.ye-rRAjtgH-ds9cAv7bQdXV_CtlaGNIgkgOCIiBM5qE';

        let supabase;
        let isSupabaseReady = false;
        let selectedCity = null;

        // Polling v√°ltoz√≥k
        let pollingTimeoutId = null;
        let isPolling = false;
        let isFetchingData = false;
        let reconnectAttempts = 0;
        const MAX_RECONNECT_ATTEMPTS = 10;
        const BASE_POLLING_INTERVAL = 5000; // 5 m√°sodperc

        // FEJLESZT√âS: Feedback √©s Offline Queue
        let feedbackTimeoutId = null;
        const OFFLINE_QUEUE_KEY = 'supabase_offline_queue';

        // Seg√©df√ºggv√©ny a mai d√°tumhoz (YYYY-MM-DD)
        function getTodayString() {
            return new Date().toISOString().split('T')[0];
        }

        // Seg√©df√ºggv√©ny az utols√≥ friss√≠t√©s id≈ëpontj√°hoz
        function updateLastSyncTime() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('hu-HU', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
            lastSyncTime.textContent = `Utols√≥ szinkroniz√°ci√≥: ${timeString}`;
        }

        // === √öJ SEG√âDF√úGGV√âNYEK A JELENT√âSHEZ ===

        /**
         * Visszaadja az aktu√°lis h√©t (H-V) els≈ë √©s utols√≥ napj√°t YYYY-MM-DD form√°tumban
         */
        function getWeekRange() {
            const now = new Date();
            // H√©tf≈ë = 0, Vas√°rnap = 6 (ISO 8601-nek megfelel≈ë h√©tkezd√©s)
            const currentDayOfWeek = (now.getDay() === 0) ? 6 : now.getDay() - 1;

            const mondayDate = new Date(now);
            // D√°tum be√°ll√≠t√°sa az aktu√°lis nap m√≠nusz a h√©t napja (h√©tf≈ëre ugrik)
            mondayDate.setDate(now.getDate() - currentDayOfWeek);
            const mondayString = mondayDate.toISOString().split('T')[0];

            const sundayDate = new Date(mondayDate);
            // H√©tf≈ë + 6 nap = Vas√°rnap
            sundayDate.setDate(mondayDate.getDate() + 6);
            const sundayString = sundayDate.toISOString().split('T')[0];

            return { start: mondayString, end: sundayString };
        }

        /**
         * Visszaadja az aktu√°lis h√≥nap els≈ë napj√°t √©s a k√∂vetkez≈ë h√≥nap els≈ë napj√°t
         * (a Supabase 'lt' - "less than" - lek√©rdez√©shez)
         */
        function getMonthRange() {
            const now = new Date();
            const monthStartDate = new Date(now.getFullYear(), now.getMonth(), 1);
            const monthStartString = monthStartDate.toISOString().split('T')[0];

            // A Supabase 'lt' (less than) query-hez a k√∂vetkez≈ë h√≥nap els≈ë napja kell
            const nextMonthDate = new Date(now.getFullYear(), now.getMonth() + 1, 1);
            const nextMonthStartString = nextMonthDate.toISOString().split('T')[0];

            // C√≠mhez a h√≥nap neve
            const monthName = now.toLocaleString('hu-HU', { month: 'long' });
            const year = now.getFullYear();

            return {
                start: monthStartString,
                end: nextMonthStartString, // Ez val√≥j√°ban a J√ñV≈ê h√≥nap els≈ë napja
                displayName: `${year}. ${monthName}`
            };
        }

        // === FEJLESZT√âS: Offline Queue Kezel≈ë F√ºggv√©nyek ===

        /**
         * Visszaadja az offline v√°r√≥list√°t a localStorage-b√≥l
         */
        function getOfflineQueue() {
            try {
                const queue = localStorage.getItem(OFFLINE_QUEUE_KEY);
                return queue ? JSON.parse(queue) : [];
            } catch (e) {
                console.error("Hiba az offline v√°r√≥lista olvas√°sa k√∂zben:", e);
                return [];
            }
        }

        /**
         * Elmenti az offline v√°r√≥list√°t a localStorage-ba
         */
        function saveOfflineQueue(queue) {
            try {
                localStorage.setItem(OFFLINE_QUEUE_KEY, JSON.stringify(queue));
                updateOfflineQueueIndicator();
            } catch (e) {
                console.error("Hiba az offline v√°r√≥lista ment√©se k√∂zben:", e);
            }
        }

        /**
         * Hozz√°ad egy elemet az offline v√°r√≥list√°hoz
         */
        function addToOfflineQueue(taskType, amount) {
            const queue = getOfflineQueue();
            const newItem = {
                id: crypto.randomUUID(),
                taskType,
                amount,
                city: selectedCity,
                timestamp: Date.now()
            };
            queue.push(newItem);
            saveOfflineQueue(queue);
            console.log(`üì¶ Elem hozz√°adva az offline v√°r√≥list√°hoz: ${taskType} (${amount})`);
        }

        /**
         * Friss√≠ti az offline v√°r√≥lista UI jelz≈ëj√©t
         */
        function updateOfflineQueueIndicator() {
            const queue = getOfflineQueue();
            if (queue.length > 0) {
                offlineQueueCount.textContent = queue.length;
                offlineQueueIndicator.classList.remove('hidden');
            } else {
                offlineQueueIndicator.classList.add('hidden');
            }
        }

        /**
         * Feldolgozza az offline v√°r√≥list√°t
         */
        async function processOfflineQueue() {
            if (!isSupabaseReady) return;

            let queue = getOfflineQueue();
            if (queue.length === 0) {
                updateOfflineQueueIndicator();
                return;
            }

            console.log(`üîÑ Offline v√°r√≥lista feldolgoz√°sa (${queue.length} elem)...`);
            showFeedback(`Offline elemek szinkroniz√°l√°sa (${queue.length})...`, "text-blue-600");

            // Sz≈±rj√ºk ki a nem ehhez a v√°roshoz tartoz√≥ elemeket (b√°r elvileg nem lehet)
            const cityQueue = queue.filter(item => item.city === selectedCity);
            const otherCitiesQueue = queue.filter(item => item.city !== selectedCity);

            let failedItems = [];

            for (const item of cityQueue) {
                try {
                    const { error } = await supabase.rpc('plaza_increment_stat', {
                        stat_name: item.taskType,
                        increment_val: item.amount,
                        city_name: item.city
                    });

                    if (error) throw error;

                    console.log(`‚úÖ Offline elem sikeresen szinkroniz√°lva: ${item.taskType} (${item.amount})`);
                } catch (error) {
                    console.error(`‚ùå Offline elem szinkroniz√°l√°sa sikertelen: ${item.id}`, error);
                    failedItems.push(item);
                }
            }

            // Csak a sikeresen feldolgozott elemeket vessz√ºk ki, a sikerteleneket + m√°s v√°rosok√©t bent hagyjuk
            const newQueue = [...otherCitiesQueue, ...failedItems];
            saveOfflineQueue(newQueue);

            if (failedItems.length === 0 && cityQueue.length > 0) {
                showFeedback("Minden offline elem szinkroniz√°lva!", "text-green-600");
            } else if (failedItems.length > 0) {
                showFeedback(`Nem siker√ºlt minden elemet szinkroniz√°lni (${failedItems.length} maradt).`, "text-orange-600");
            }

            // V√°r√≥lista feldolgoz√°s ut√°n friss√≠tj√ºk az adatokat
            if (cityQueue.length > 0) {
                await new Promise(resolve => setTimeout(resolve, 500)); // V√°rjunk a replik√°ci√≥ra
                await fetchInitialData();
            }
        }

        /**
         * K√âR√âS: √öj seg√©df√ºggv√©ny a k√°rtya szeg√©ly√©nek be√°ll√≠t√°s√°hoz
         */
        function setCardBorder(city) {
            mainCard.classList.remove('border-gyor', 'border-kaposvar', 'border-pecs');
            if (city) {
                mainCard.classList.add(`border-${city}`);
            }
        }

        /**
         * F≈ë inicializ√°l√≥ f√ºggv√©ny (App indul√°s)
         */
        function initApp() {
            selectedCity = localStorage.getItem('selectedCity');
            setCardBorder(selectedCity); // K√âR√âS: Szeg√©ly be√°ll√≠t√°sa

            if (selectedCity) {
                citySelectionView.classList.add('hidden');
                userView.classList.remove('hidden');
                loadingCityName.textContent = `Helysz√≠n: ${CITY_NAMES[selectedCity]}`;
                currentCityDisplay.textContent = CITY_NAMES[selectedCity];
                initSupabase();
            } else {
                citySelectionView.classList.remove('hidden');
                userView.classList.add('hidden');
                adminView.classList.add('hidden');
            }
            // Friss√≠ts√ºk az indik√°tort indul√°skor
            updateOfflineQueueIndicator();
        }

        /**
         * A Supabase kapcsolatot inicializ√°lja
         */
        async function initSupabase() {
            try {
                if (!SUPABASE_URL || !SUPABASE_ANON_KEY) {
                    throw new Error("Hi√°nyz√≥ Supabase URL vagy Anon Key.");
                }

                if (!supabase) {
                    supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                    console.log("‚úÖ Supabase kliens inicializ√°lva.");
                }

                // Elt√°roljuk a kor√°bbi st√°tuszt
                const wasOffline = !isSupabaseReady;
                const success = await fetchInitialData();

                if (!success) {
                    console.log("‚ö†Ô∏è Kezdeti adatlek√©r√©s sikertelen, exponenci√°lis backoff √∫jrapr√≥b√°lkoz√°s...");
                    reconnectAttempts++;
                    const backoffDelay = Math.min(5000 * Math.pow(2, reconnectAttempts - 1), 30000);

                    if (reconnectAttempts < MAX_RECONNECT_ATTEMPTS) {
                        if (!userContent.classList.contains('hidden')) {
                            // Maradjon l√°that√≥
                            showFeedback(`Kapcsolat sikertelen (${reconnectAttempts}/${MAX_RECONNECT_ATTEMPTS}). √öjrapr√≥b√°lkoz√°s ${backoffDelay / 1000}s m√∫lva...`, "text-orange-600", true);
                        }
                        setTimeout(initSupabase, backoffDelay);
                    } else {
                        showFeedback("Kapcsolat sikertelen. K√©rlek friss√≠tsd az oldalt.", "text-red-600", true);
                    }
                    return;
                }

                console.log("‚úÖ Kezdeti adatlek√©r√©s sikeres, polling ind√≠t√°sa.");
                reconnectAttempts = 0;

                // FEJLESZT√âS: Csak akkor jelezz√ºk, ha offline-b√≥l j√∂tt vissza
                if (wasOffline) {
                    showFeedback("Kapcsolat helyre√°llt!", "text-green-600");
                    // Ind√≠tsuk el az offline v√°r√≥lista feldolgoz√°s√°t
                    await processOfflineQueue();
                }

                // KRITIKUS JAV√çT√ÅS: Recursive setTimeout polling ind√≠t√°sa
                startPolling();

            } catch (error) {
                console.error("‚ùå Supabase kritikus inicializ√°l√°si hiba:", error);
                isSupabaseReady = false;
                todayData = createEmptyDayData();
                updateButtonCounts();
                loadingOverlay.classList.add('hidden');
                userContent.classList.remove('hidden');
                showFeedback("Kritikus hiba a kapcsol√≥d√°sban.", "text-red-600", true); // Sticky
                updatePollingIndicator(false);
            }
        }

        // ... (V√°rosv√°laszt√≥ √©s v√°lt√°s gomb esem√©nykezel≈ëi v√°ltozatlanok) ...

        citySelectionView.addEventListener('click', (e) => {
            const button = e.target.closest('.city-btn');
            if (!button) return;

            selectedCity = button.dataset.city;
            localStorage.setItem('selectedCity', selectedCity);
            initApp(); // Ez m√°r tartalmazza a setCardBorder h√≠v√°st
        });

        changeCityBtn.addEventListener('click', () => {
            stopPolling();
            localStorage.removeItem('selectedCity');
            // setCardBorder(null); // Nem sz√ºks√©ges, mert az oldal √∫jrat√∂lt
            window.location.reload();
        });

        /**
         * KRITIKUS JAV√çT√ÅS: Recursive setTimeout polling
         */
        function startPolling() {
            if (isPolling) {
                console.log("‚è≥ Polling m√°r fut.");
                return;
            }

            isPolling = true;
            updatePollingIndicator(true);
            console.log("üîÑ Polling elind√≠tva (recursive setTimeout)");
            scheduleNextPoll();
        }

        /**
         * JAV√çT√ÅS: K√∂vetkez≈ë poll √ºtemez√©se
         */
        function scheduleNextPoll() {
            if (!isPolling) return;

            // Ha admin n√©zetben van, ne pollingoljon
            if (!adminView.classList.contains('hidden')) {
                console.log("üìä Admin n√©zet akt√≠v, polling sz√ºnetel.");
                pollingTimeoutId = setTimeout(scheduleNextPoll, BASE_POLLING_INTERVAL);
                return;
            }

            pollingTimeoutId = setTimeout(async () => {
                await pollData();
                scheduleNextPoll(); // Recursive h√≠v√°s
            }, BASE_POLLING_INTERVAL);
        }

        /**
         * JAV√çT√ÅS: Adatok lek√©r√©se polling sor√°n
         */
        async function pollData() {
            if (isFetchingData) {
                console.log("‚è≥ El≈ëz≈ë fetch m√©g fut, kihagyva.");
                return;
            }

            try {
                isFetchingData = true;
                const wasOffline = !isSupabaseReady;
                const success = await fetchInitialData();

                if (success) {
                    updatePollingIndicator(true);
                    reconnectAttempts = 0;

                    // FEJLESZT√âS: Ha offline-b√≥l j√∂tt√ºnk vissza
                    if (wasOffline) {
                        showFeedback("Kapcsolat helyre√°llt!", "text-green-600");
                        await processOfflineQueue();
                    }

                } else {
                    updatePollingIndicator(false);
                    reconnectAttempts++;

                    if (reconnectAttempts >= 3 && isSupabaseReady) { // Csak akkor jelezz√ºk, ha m√°r volt kapcsolat
                        showFeedback(`Kapcsolat instabil (${reconnectAttempts} sikertelen pr√≥b√°lkoz√°s)`, "text-orange-600", true); // Sticky
                    }
                }
            } catch (error) {
                console.error("‚ùå Polling hiba:", error);
                updatePollingIndicator(false);
            } finally {
                isFetchingData = false;
            }
        }

        /**
         * JAV√çT√ÅS: Polling le√°ll√≠t√°sa
         */
        function stopPolling() {
            console.log("üõë Polling le√°ll√≠tva.");
            isPolling = false;
            if (pollingTimeoutId) {
                clearTimeout(pollingTimeoutId);
                pollingTimeoutId = null;
            }
            updatePollingIndicator(false);
        }

        /**
         * √öJ: Polling indik√°tor friss√≠t√©se
         */
        function updatePollingIndicator(isActive) {
            if (isActive) {
                pollingIndicator.classList.remove('polling-inactive');
                pollingIndicator.classList.add('polling-active');
                pollingIndicator.title = 'Szinkroniz√°ci√≥ akt√≠v';
            } else {
                pollingIndicator.classList.remove('polling-active');
                pollingIndicator.classList.add('polling-inactive');
                pollingIndicator.title = 'Szinkroniz√°ci√≥ inakt√≠v';
            }
        }

        /**
         * JAV√çTVA: Lek√©ri a mai nap kezdeti adatait
         */
        async function fetchInitialData() {
            if (!supabase) return false;

            const today = getTodayString();
            try {
                const { data, error } = await supabase
                    .from('plaza_daily_stats')
                    .select('*')
                    .eq('date', today)
                    .eq('city', selectedCity)
                    .single();

                // Ha a kapcsolat megszakadt
                if (error && error.code !== 'PGRST116') {
                    console.error("‚ùå Adat lek√©r√©si hiba:", error.message);
                    if (isSupabaseReady) {
                        showFeedback("Kapcsolat megszakadt.", "text-orange-600", true); // Sticky
                    }
                    isSupabaseReady = false; // √Åll√≠tsuk be itt
                    return false;
                }

                // Ha a kapcsolat helyre√°llt
                if (!isSupabaseReady) {
                    // showFeedback("Kapcsolat helyre√°llt!", "text-green-600"); // Ezt a h√≠v√≥ f√ºggv√©ny kezeli
                    isSupabaseReady = true; // √Åll√≠tsuk be itt
                }

                if (data) {
                    todayData = { ...createEmptyDayData(), ...data };
                } else {
                    todayData = createEmptyDayData();
                }

                updateButtonCounts();
                updateLastSyncTime();
                loadingOverlay.classList.add('hidden');
                userContent.classList.remove('hidden');
                return true;
            } catch (err) {
                console.error("‚ùå H√°l√≥zati hiba:", err);
                isSupabaseReady = false; // H√°l√≥zati hiba eset√©n is offline-ba ker√ºl√ºnk
                return false;
            }
        }

        // === N√âZETV√ÅLT√ì LOGIKA (Admin) ===
        showAdminBtn.addEventListener('click', async (e) => {
            // --- M√ìDOS√çT√ÅS KEZDETE ---
            // Hozz√°adva a metaKey (Command) ellen≈ërz√©s is a macOS kompatibilit√°s√©rt
            if (!((e.ctrlKey || e.metaKey) && e.altKey)) { return; }
            // --- M√ìDOS√çT√ÅS V√âGE ---

            adminCityFilter.value = selectedCity;

            userView.classList.add('hidden');
            adminView.classList.remove('hidden');
            setActivePeriodButton('daily');
            await generateReport('daily');
        });

        // M√ìDOS√çT√ÅS: Esem√©nykezel≈ë f√ºggv√©ny a vissza gombokhoz
        const handleBackToUser = () => {
            adminView.classList.add('hidden');
            userView.classList.remove('hidden');
        };

        backToUserBtn.addEventListener('click', handleBackToUser);
        backToUserBtnTop.addEventListener('click', handleBackToUser); // √öJ

        // === ADATR√ñGZ√çT≈ê LOGIKA (V√°rossal) ===
        // BAL KLIKK
        taskButtonsContainer.addEventListener('click', (e) => {
            const button = e.target.closest('.task-btn');
            if (!button) return;
            const taskType = button.dataset.taskType;
            if (taskType) {
                button.classList.add('btn-press-feedback');
                setTimeout(() => button.classList.remove('btn-press-feedback'), 150);

                const currentCount = todayData[taskType] || 0;
                todayData[taskType] = currentCount + 1;
                updateButtonCounts();
                showFeedback("Sikeresen r√∂gz√≠tve!", "text-green-600");

                updateTaskCount(taskType, 1); // Nem kell await, a h√°tt√©rben fut
            }
        });

        // JOBB KLIKK
        taskButtonsContainer.addEventListener('contextmenu', (e) => {
            e.preventDefault();
            const button = e.target.closest('.task-btn');
            if (!button) return;
            const taskType = button.dataset.taskType;
            if (taskType) {
                button.classList.add('btn-press-feedback');
                setTimeout(() => button.classList.remove('btn-press-feedback'), 150);

                const currentCount = todayData[taskType] || 0;
                if (currentCount <= 0) {
                    showFeedback("Az √©rt√©k m√°r 0!", "text-orange-600");
                    return;
                }
                todayData[taskType] = currentCount - 1;
                updateButtonCounts();
                showFeedback("√ârt√©k cs√∂kkentve!", "text-orange-600");

                updateTaskCount(taskType, -1); // Nem kell await, a h√°tt√©rben fut
            }
        });

        /**
         * FEJLESZT√âS: Visszajelz≈ë √ºzenet
         * @param {string} message - A megjelen√≠tend≈ë √ºzenet.
         * @param {string} colorClass - Tailwind sz√≠noszt√°ly (pl. 'text-green-600').
         * @param {boolean} [sticky=false] - Ha true, az √ºzenet nem t≈±nik el automatikusan.
         */
        function showFeedback(message, colorClass = 'text-green-600', sticky = false) {
            // T√∂r√∂lj√ºk az el≈ëz≈ë id≈ëz√≠t≈ët, ha volt
            if (feedbackTimeoutId) {
                clearTimeout(feedbackTimeoutId);
                feedbackTimeoutId = null;
            }

            feedbackMessage.textContent = message;
            feedbackMessage.className = "absolute inset-0 text-center font-semibold transition-opacity duration-300 opacity-100"; // Reset
            feedbackMessage.classList.add(colorClass);

            // Csak akkor t≈±nj√∂n el, ha nem "sticky"
            if (!sticky) {
                feedbackTimeoutId = setTimeout(() => {
                    if (feedbackMessage.textContent === message) { // Csak ha m√©g mindig ugyanaz az √ºzenet
                        feedbackMessage.classList.remove('opacity-100');
                        feedbackTimeoutId = null;
                    }
                }, 3000); // 3 m√°sodpercig l√°tszik
            }
        }

        /**
         * KRITIKUS JAV√çT√ÅS + OFFLINE FEJLESZT√âS
         * Elk√ºldi a friss√≠t√©st, vagy v√°r√≥list√°ba helyezi, ha offline van.
         */
        async function updateTaskCount(taskType, amount) {
            if (!isSupabaseReady) {
                console.log("‚ö†Ô∏è Offline m√≥d: Hozz√°ad√°s a v√°r√≥list√°hoz.");
                showFeedback("Nincs kapcsolat, helyi r√∂gz√≠t√©s!", "text-orange-600", true); // Sticky
                addToOfflineQueue(taskType, amount);
                return;
            }

            try {
                // Az RPC h√≠v√°s elindul a h√°tt√©rben (nincs await)
                supabase.rpc('plaza_increment_stat', {
                    stat_name: taskType,
                    increment_val: amount,
                    city_name: selectedCity
                }).then(async ({ error }) => {
                    if (error) {
                        throw error;
                    }

                    console.log(`‚úÖ RPC h√≠v√°s sikeres: ${selectedCity} - ${taskType} ${amount}`);

                    // KRITIKUS JAV√çT√ÅS: 500ms k√©sleltet√©s a race condition elker√ºl√©s√©re
                    // Mivel ez a .then() √°gban van, nem blokkolja a UI-t
                    await new Promise(resolve => setTimeout(resolve, 500));
                    await fetchInitialData(); // Friss√≠ts√ºk az adatokat

                }).catch((error) => {
                    // Ha az aszinkron h√≠v√°s hib√°t dob
                    console.error("‚ùå Supabase RPC hiba (aszinkron):", error);
                    showFeedback("Adatb√°zis ment√©si hiba!", "text-red-600", true); // Sticky
                    isSupabaseReady = false; // Kapcsolat elveszett

                    // Mivel a ment√©s sikertelen volt, visszacsin√°ljuk a UI v√°ltoz√°st
                    // √©s hozz√°adjuk az offline v√°r√≥list√°hoz
                    todayData[taskType] = (todayData[taskType] || 0) - amount;
                    updateButtonCounts();
                    addToOfflineQueue(taskType, amount);
                });

            } catch (error) {
                // Ez a catch √°g val√≥sz√≠n≈±leg nem fog lefutni, de biztons√°g kedv√©√©rt
                console.error("‚ùå Supabase RPC hiba (szinkron):", error);
                showFeedback("Adatb√°zis ment√©si hiba!", "text-red-600", true); // Sticky
                isSupabaseReady = false;
                addToOfflineQueue(taskType, amount);
            }
        }

        // updateButtonCounts (V√°ltozatlan)
        function updateButtonCounts() {
            Object.keys(TASK_NAMES).forEach(taskKey => {
                const button = taskButtonsContainer.querySelector(`[data-task-type="${taskKey}"]`);
                if (button) {
                    const counterElement = button.querySelector('.task-counter');
                    const count = todayData[taskKey] || 0;
                    if (counterElement) {
                        if (count > 0) {
                            counterElement.textContent = count;
                            counterElement.classList.remove('hidden');
                        } else {
                            counterElement.classList.add('hidden');
                        }
                    }
                }
            });
        }

        // === ADMIN STATISZTIKA LOGIKA (V√°rosfilterrel) ===
        // ... (Esem√©nykezel≈ëk √©s setActivePeriodButton v√°ltozatlanok) ...

        periodButtons.forEach(button => {
            button.addEventListener('click', async () => {
                const period = button.dataset.period;
                setActivePeriodButton(period);
                await generateReport(period);
            });
        });

        adminCityFilter.addEventListener('change', async () => {
            const currentPeriod = document.querySelector('.period-btn.text-blue-600').dataset.period || 'daily';
            setActivePeriodButton(currentPeriod);
            await generateReport(currentPeriod);
        });

        function setActivePeriodButton(activePeriod) {
            periodButtons.forEach(btn => {
                if (btn.dataset.period === activePeriod) {
                    btn.classList.add('text-blue-600', 'border-blue-600');
                    btn.classList.remove('text-gray-500', 'border-transparent');
                } else {
                    btn.classList.remove('text-blue-600', 'border-blue-600');
                    btn.classList.add('text-gray-500', 'border-transparent');
                }
            });

            // --- M√ìDOS√çT√ÅS KEZDETE ---
            // Kezelj√ºk az Egy√©ni n√©zet UI elemeit
            if (activePeriod === 'custom') {
                customDateRange.classList.remove('hidden');
                deleteDaySection.classList.add('hidden'); // Egy√©ni n√©zetben nincs t√∂rl√©s

                // Ha nincs kit√∂ltve a d√°tum, t√∂lts√ºk ki alap√©rtelmezetten a mai nappal
                if (!customStartDate.value) customStartDate.value = getTodayString();
                if (!customEndDate.value) customEndDate.value = getTodayString();

                return; // Kil√©p√ºnk, mert a t√∂bbi logika (t√∂rl√©s) ide nem kell
            } else {
                customDateRange.classList.add('hidden');

                // Fontos: T√∂r√∂lj√ºk a hiba√ºzenetet ha elnavig√°lunk
                customDateError.classList.add('hidden');
            }
            // --- M√ìDOS√çT√ÅS V√âGE ---

            // --- M√ìDOS√çT√ÅS KEZDETE ---
            // Most m√°r napi n√©zetben mindig l√°tszik a t√∂rl√©s szekci√≥
            const cityFilter = adminCityFilter.value;
            if (activePeriod === 'daily') {
                deleteDaySection.classList.remove('hidden');
                deleteDayBtn.disabled = false;

                // Att√≥l f√ºgg≈ëen, hogy "√ñsszes√≠tve" vagy konkr√©t v√°ros van-e kiv√°lasztva,
                // m√°s figyelmeztet≈ë √ºzenetet jelen√≠t√ºnk meg.
                if (cityFilter === 'osszesitve') {
                    deleteWarningMessage.textContent = `FIGYELEM: Ez a m≈±velet v√©glegesen t√∂rli a kiv√°lasztott nap adatait MINDH√ÅROM V√ÅROSB√ìL!`;
                } else {
                    deleteWarningMessage.textContent = `Figyelem: Ez t√∂rli a kiv√°lasztott nap adatait a(z) ${CITY_NAMES[cityFilter]} helysz√≠nr≈ël!`;
                }

                if (!deleteDateInput.value) {
                    deleteDateInput.value = getTodayString();
                }
            } else {
                deleteDaySection.classList.add('hidden');
            }
            // --- M√ìDOS√çT√ÅS V√âGE ---
        }

        /**
         * Legener√°lja a riportot (Figyelembe veszi a V√ÅROS filtert)
         */
        async function generateReport(period) {
            adminLoading.classList.remove('hidden');
            reportTitle.textContent = "";
            reportContent.innerHTML = "";
            // √ñsszes chart t√∂rl√©se
            if (reportChartInstance) reportChartInstance.destroy();
            if (trendChartInstance) trendChartInstance.destroy();
            if (distributionChartInstance) distributionChartInstance.destroy();
            if (comparisonChartInstance) comparisonChartInstance.destroy();

            let aggregatedData = createEmptyDayData();
            let title = "";

            const cityFilter = adminCityFilter.value;

            if (!isSupabaseReady) {
                reportContent.innerHTML = "<p class='text-center text-orange-600'>Nincs adatb√°zis kapcsolat. Az adatok nem t√∂lthet≈ëk be.</p>";
                adminLoading.classList.add('hidden');
                return;
            }

            try {
                let reportData = [];
                let query = supabase.from('plaza_daily_stats').select('*');

                if (period === 'daily') {
                    const today = getTodayString();
                    title = "Mai statisztika";
                    query = query.eq('date', today);
                }

                // --- M√ìDOS√çT√ÅS KEZDETE ---
                if (period === 'weekly') {
                    const week = getWeekRange();
                    // C√≠m form√°z√°sa a k√©r√©snek megfelel≈ëen
                    title = `Aktu√°lis h√©t (${week.start} - ${week.end})`;

                    // A lek√©rdez√©s >= h√©tf≈ë √âS <= vas√°rnap
                    query = query.gte('date', week.start).lte('date', week.end);
                }
                if (period === 'monthly') {
                    const month = getMonthRange();
                    title = `Havi statisztika (${month.displayName})`;

                    // A lek√©rdez√©s >= h√≥nap els≈ë napja √âS < k√∂vetkez≈ë h√≥nap els≈ë napja
                    // (az 'end' a k√∂vetkez≈ë h√≥nap els≈ë napja)
                    query = query.gte('date', month.start).lt('date', month.end);
                }

                if (period === 'custom') {
                    // D√°tumok valid√°l√°sa
                    const start = customStartDate.value;
                    const end = customEndDate.value;

                    if (!start || !end) {
                        // Ha nincs kiv√°lasztva d√°tum
                        reportContent.innerHTML = "<p class='text-center text-gray-500'>K√©rlek v√°lassz ki egy id≈ëszakot √©s kattints a Lek√©rdez√©s gombra.</p>";
                        adminLoading.classList.add('hidden');
                        return;
                    }

                    if (start > end) {
                        reportContent.innerHTML = "<p class='text-center text-red-500'>A kezd≈ë d√°tum nem lehet k√©s≈ëbbi, mint a z√°r√≥ d√°tum!</p>";
                        adminLoading.classList.add('hidden');
                        return;
                    }

                    title = `Egy√©ni id≈ëszak (${start} - ${end})`;
                    query = query.gte('date', start).lte('date', end);
                }
                // --- M√ìDOS√çT√ÅS V√âGE ---

                // M√ìDOS√çT√ÅS: JAV√çTOTT LOGIKA - MINDIG LEK√âRJ√úK AZ √ñSSZES ADATOT
                // Nem sz≈±r√ºnk v√°rosra a DATABASE szinten, ha riportot k√©sz√≠t√ºnk,
                // mert az √∂sszehasonl√≠t√≥ grafikonhoz kell a t√∂bbi v√°ros adata is.
                /*
                if (cityFilter !== 'osszesitve') {
                    query = query.eq('city', cityFilter);
                    title += ` - ${CITY_NAMES[cityFilter]}`;
                } else {
                    title += ` - √ñsszes√≠tve`;
                }
                */

                // Csak a c√≠met √°ll√≠tjuk be a filter alapj√°n
                if (cityFilter !== 'osszesitve') {
                    title += ` - ${CITY_NAMES[cityFilter]}`;
                } else {
                    title += ` - √ñsszes√≠tve`;
                }

                const { data, error } = await query;
                if (error) throw error;

                // ITT V√ÅLASZTJUK SZ√âT:
                // fullData = Minden v√°ros adata (√ñsszehasonl√≠t√≥ grafikonhoz)
                // filteredData = A v√°lasztott n√©zet adata (T√°bl√°zat, Trend, Eloszl√°s)

                const fullData = data;
                let filteredData = data;

                if (cityFilter !== 'osszesitve') {
                    filteredData = fullData.filter(d => d.city === cityFilter);
                }

                // --- M√ìDOS√çT√ÅS KEZDETE ---                
                // Be√°ll√≠tjuk a riport f≈ë c√≠m√©t
                reportTitle.textContent = title;

                if (cityFilter !== 'osszesitve') {
                    // Ha NEM √∂sszes√≠tett n√©zet, a r√©gi logika fut a FILTEREZETT adattal:
                    // 1. Aggreg√°ljuk a (m√°r v√°rosra sz≈±rt) adatokat
                    if (filteredData && filteredData.length > 0) {
                        filteredData.forEach(day => {
                            aggregatedData = sumAggregates(aggregatedData, day);
                        });
                    }
                    // 2. L√©trehozunk EGY t√°bl√°zatot
                    reportContent.innerHTML = createReportTableHTML(aggregatedData, `R√©szletez√©s: ${CITY_NAMES[cityFilter]}`);
                    // 3. Renderelj√ºk a grafikont
                    renderChart(aggregatedData, title);

                } else {
                    // Ha √ñSSZES√çTETT n√©zet (Itt a filteredData == fullData)

                    let totalAggregatedData = createEmptyDayData();
                    let gyorAggregatedData = createEmptyDayData();
                    let kaposvarAggregatedData = createEmptyDayData();
                    let pecsAggregatedData = createEmptyDayData();

                    if (filteredData && filteredData.length > 0) {
                        filteredData.forEach(day => {
                            // 1. Mindig hozz√°adjuk a f≈ë √∂sszes√≠t≈ëh√∂z
                            totalAggregatedData = sumAggregates(totalAggregatedData, day);

                            // 2. Hozz√°adjuk a megfelel≈ë v√°rosi √∂sszes√≠t≈ëh√∂z
                            if (day.city === 'gyor') {
                                gyorAggregatedData = sumAggregates(gyorAggregatedData, day);
                            } else if (day.city === 'kaposvar') {
                                kaposvarAggregatedData = sumAggregates(kaposvarAggregatedData, day);
                            } else if (day.city === 'pecs') {
                                pecsAggregatedData = sumAggregates(pecsAggregatedData, day);
                            }
                        });
                    }

                    // Most renderelj√ºk a HTML-t: 4 k√ºl√∂n t√°bl√°zat
                    let html = createReportTableHTML(totalAggregatedData, "√ñsszes√≠tett Eredm√©nyek");
                    html += createReportTableHTML(gyorAggregatedData, "R√©szletez√©s: Gy≈ër");
                    html += createReportTableHTML(kaposvarAggregatedData, "R√©szletez√©s: Kaposv√°r");
                    html += createReportTableHTML(pecsAggregatedData, "R√©szletez√©s: P√©cs");

                    reportContent.innerHTML = html;

                    // A grafikont tov√°bbra is csak a teljes √∂sszes√≠t√©sr≈ël renderelj√ºk
                    renderChart(totalAggregatedData, "√ñsszes√≠tett Statisztika");
                }

                // --- DASHBOARD 2.0 RENDEREL√âS ---
                // Minden esetben megh√≠vjuk az √∫j grafikonokat is

                // Aggreg√°lt (Distribution) - FILTEREZETT ADATB√ìL
                let finalAggregatedForDist = createEmptyDayData();
                if (filteredData.length > 0) {
                    filteredData.forEach(day => finalAggregatedForDist = sumAggregates(finalAggregatedForDist, day));
                }
                renderDistributionChart(finalAggregatedForDist);

                // Nyers (Trend - FILTEREZETT ADATB√ìL)
                // (Mert a trendn√©l azt akarjuk l√°tni, amit kiv√°lasztottunk)
                if (filteredData.length > 0) {
                    renderTrendChart(filteredData);
                } else {
                    // √úres chart h√≠v√°s, hogy elt≈±nj√∂n az el≈ëz≈ë
                    renderTrendChart([]);
                }

                // √ñsszehasonl√≠t√°s (Comparison - TELJES ADATB√ìL!)
                // (Mert itt l√°tni akarjuk a t√∂bbi v√°rost is a benchmarkinghoz)
                if (fullData.length > 0) {
                    renderCityComparisonChart(fullData);
                } else {
                    renderCityComparisonChart([]);
                }
                // --------------------------------
                // --- M√ìDOS√çT√ÅS V√âGE ---

            } catch (error) {
                // --- M√ìDOS√çT√ÅS KEZDETE (HIB√ÅS BLOKK CSER√âJE) ---
                console.error("‚ùå Hiba a riport gener√°l√°sa k√∂zben:", error);
                reportContent.innerHTML = "<p class='text-center text-red-600'>Hiba t√∂rt√©nt az adatok lek√©rdez√©se k√∂zben.</p>";
            } finally {
                adminLoading.classList.add('hidden');
            }
        } // <-- Ez a '}' z√°rja a generateReport() f√ºggv√©nyt. A hib√°s '});' t√∂r√∂lve.
        // --- M√ìDOS√çT√ÅS V√âGE ---

        // --- M√ìDOS√çT√ÅS KEZDETE: A T√ñRL√âS LOGIKA VISSZA√ÅLL√çT√ÅSA ---
        deleteDayBtn.addEventListener('click', async () => {
            const dateToDelete = deleteDateInput.value;
            const cityToDelete = adminCityFilter.value;

            if (!dateToDelete) {
                deleteFeedback.textContent = "K√©rlek v√°lassz egy d√°tumot!";
                deleteFeedback.className = "text-center h-4 mt-3 text-sm font-medium text-red-600";
                return;
            }

            // Meger≈ës√≠t≈ë k√©rd√©s
            let confirmed = false;
            if (cityToDelete === 'osszesitve') {
                confirmed = window.confirm(`Biztosan t√∂rl√∂d a(z) ${dateToDelete} napot MINDH√ÅROM V√ÅROSB√ìL? Ez nem vonhat√≥ vissza!`);
            } else {
                confirmed = window.confirm(`Biztosan t√∂rl√∂d a(z) ${dateToDelete} napot a(z) ${CITY_NAMES[cityToDelete]} helysz√≠nr≈ël? Ez nem vonhat√≥ vissza!`);
            }

            if (!confirmed) {
                return;
            }

            deleteDayBtn.disabled = true;
            deleteFeedback.textContent = "T√∂rl√©s folyamatban...";
            deleteFeedback.className = "text-center h-4 mt-3 text-sm font-medium text-gray-600";

            try {
                let rpcCall;
                if (cityToDelete === 'osszesitve') {
                    // √öj RPC h√≠v√°s a glob√°lis t√∂rl√©shez
                    rpcCall = supabase.rpc('plaza_delete_day_all_cities', {
                        date_to_delete: dateToDelete
                    });
                } else {
                    // R√©gi RPC h√≠v√°s a v√°ros-specifikus t√∂rl√©shez
                    rpcCall = supabase.rpc('plaza_delete_day', {
                        city_to_delete: cityToDelete,
                        date_to_delete: dateToDelete
                    });
                }

                const { error } = await rpcCall; // V√°rakoz√°s az RPC h√≠v√°sra

                if (error) throw error;

                deleteFeedback.textContent = "Sikeres t√∂rl√©s!";
                deleteFeedback.className = "text-center h-4 mt-3 text-sm font-medium text-green-600";

                // V√°rakoz√°s a replik√°ci√≥ra
                await new Promise(resolve => setTimeout(resolve, 1000));

                await generateReport('daily'); // Friss√≠ts√ºk a n√©zetet

                // Visszajelz√©s elt√ºntet√©se a try √°gban
                setTimeout(() => deleteFeedback.textContent = "", 3000);

            } catch (error) {
                console.error("‚ùå T√∂rl√©si hiba:", error);
                deleteFeedback.textContent = "Hiba a t√∂rl√©s sor√°n.";
                deleteFeedback.className = "text-center h-4 mt-3 text-sm font-medium text-red-600";
                // Visszajelz√©s elt√ºntet√©se a catch √°gban
                setTimeout(() => deleteFeedback.textContent = "", 3000);
            } finally {
                deleteDayBtn.disabled = false;

                // A 'finally' blokkban csak a gomb enged√©lyez√©se marad,
                // a visszajelz√©s elt√ºntet√©s√©t a try/catch √°gak kezelik.
            }
        });


        // √öJ: Custom Query Gomb Esem√©nykezel≈ë
        customQueryBtn.addEventListener('click', async () => {
            customDateError.classList.add('hidden');
            const start = customStartDate.value;
            const end = customEndDate.value;

            if (!start || !end) {
                customDateError.textContent = "K√©rlek add meg mindk√©t d√°tumot!";
                customDateError.classList.remove('hidden');
                return;
            }

            if (start > end) {
                customDateError.textContent = "A kezd≈ë d√°tum nem lehet k√©s≈ëbbi, mint a z√°r√≥ d√°tum!";
                customDateError.classList.remove('hidden');
                return;
            }

            await generateReport('custom');
        });
        // --- M√ìDOS√çT√ÅS V√âGE ---

        // === Seg√©df√ºggv√©nyek (T√∂bbnyire v√°ltozatlan) ===

        function sumAggregates(agg1, agg2) {
            const result = { ...agg1 };
            for (const key in agg2) {
                if (key !== 'date' && key !== 'city' && Object.prototype.hasOwnProperty.call(agg2, key) && typeof agg2[key] === 'number') {
                    result[key] = (result[key] || 0) + agg2[key];
                }
            }
            return result;
        }

        // --- M√ìDOS√çT√ÅS: A getLastNDays funkci√≥t kommentezz√ºk, m√°r nem haszn√°lt ---
        /*
        function getLastNDays(n) {
            const dates = [];
            for (let i = 0; i < n; i++) {
                const d = new Date();
                d.setDate(d.getDate() - i);
                dates.push(d.toISOString().split('T')[0]);
            }
            return dates.reverse();
        }
        */

        /**
         * M√ìDOS√çT√ÅS: Ezt a f√ºggv√©nyt √°tnevezt√ºk √©s kib≈ëv√≠tett√ºk,
         * hogy egy c√≠met is elfogadjon, √©s egy teljes, √∂n√°ll√≥ t√°bl√°zat-modult hozzon l√©tre.
         */
        function createReportTableHTML(aggregatedData, tableTitle) {
            let total = 0;
            let rows = Object.keys(TASK_NAMES).map(taskKey => {
                const count = aggregatedData[taskKey] || 0;
                total += count;
                return createRowHTML(TASK_NAMES[taskKey], count);
            }).join('');

            return `
                <!-- Ez egy r√©sz-riport kont√©ner -->
                <div class="bg-white rounded-lg shadow border border-gray-200 w-full mx-auto mb-8">  <!-- M√ìDOS√çT√ÅS: max-w-2xl t√∂r√∂lve, w-full helyette -->
                    <!-- √öJ: Alc√≠m a t√°bl√°zatnak -->
                    <h4 class="text-sm font-semibold text-gray-700 p-2 border-b border-gray-200">${tableTitle}</h4>
                    <table class="w-full table-fixed"> <!-- M√ìDOS√çT√ÅS: table-fixed a sz√©less√©g tart√°s√°hoz -->
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="w-2/3 p-2 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Esem√©ny t√≠pusa</th>
                                <th class="w-1/3 p-2 text-right text-xs font-semibold text-gray-600 uppercase tracking-wider">Darab</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-200">
                            ${rows}
                            <tr class="bg-gray-100 font-bold">
                                <td class="p-2 text-sm text-gray-800">√ñsszesen</td>
                                <td class="p-2 text-sm text-gray-900 text-right">${total}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            `;
        }

        function createRowHTML(name, count) {
            return `
                <tr class="border-b border-gray-200">
                    <td class="p-2 text-xs md:text-sm font-medium text-gray-700 break-words">${name}</td>
                    <td class="p-2 text-xs md:text-sm font-semibold text-gray-900 text-right">${count}</td>
                </tr>
            `;
        }

        function renderChart(aggregatedData, titleLabel) {
            const ctx = reportChartCanvas.getContext('2d');
            if (reportChartInstance) reportChartInstance.destroy();
            const labels = Object.values(TASK_NAMES);
            const data = Object.keys(TASK_NAMES).map(key => aggregatedData[key] || 0);

            // --- M√ìDOS√çT√ÅS KEZDETE ---
            const backgroundColors = [
                'rgba(59, 130, 246, 0.7)', 'rgba(14, 165, 233, 0.7)', 'rgba(220, 38, 38, 0.7)',
                'rgba(234, 179, 8, 0.7)', 'rgba(75, 85, 99, 0.7)', 'rgba(147, 51, 234, 0.7)',
                'rgba(22, 163, 74, 0.7)' // √öJ (green-600)
            ];
            const borderColors = [
                'rgba(59, 130, 246, 1)', 'rgba(14, 165, 233, 1)', 'rgba(220, 38, 38, 1)',
                'rgba(234, 179, 8, 1)', 'rgba(75, 85, 99, 1)', 'rgba(147, 51, 234, 1)',
                'rgba(22, 163, 74, 1)' // √öJ (green-600)
            ];
            // --- M√ìDOS√çT√ÅS V√âGE ---

            reportChartInstance = new Chart(ctx, {
                type: 'bar',
                data: { labels, datasets: [{ label: 'Darabsz√°m', data, backgroundColor: backgroundColors, borderColor: borderColors, borderWidth: 1 }] },
                options: {
                    responsive: true, maintainAspectRatio: true,
                    plugins: { legend: { display: false }, title: { display: true, text: titleLabel, font: { size: 16 } } },
                    scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } }
                }
            });
        }

        // FEJLESZT√âS: Dashboard 2.0 Render Functions

        const CHART_COLORS = {
            bg: [
                'rgba(59, 130, 246, 0.7)', 'rgba(14, 165, 233, 0.7)', 'rgba(220, 38, 38, 0.7)',
                'rgba(234, 179, 8, 0.7)', 'rgba(75, 85, 99, 0.7)', 'rgba(147, 51, 234, 0.7)',
                'rgba(22, 163, 74, 0.7)'
            ],
            border: [
                'rgba(59, 130, 246, 1)', 'rgba(14, 165, 233, 1)', 'rgba(220, 38, 38, 1)',
                'rgba(234, 179, 8, 1)', 'rgba(75, 85, 99, 1)', 'rgba(147, 51, 234, 1)',
                'rgba(22, 163, 74, 1)'
            ]
        };

        function renderDistributionChart(data) {
            const ctx = distributionChartCanvas.getContext('2d');
            if (distributionChartInstance) distributionChartInstance.destroy();

            const values = Object.values(TASK_NAMES).map((name, index) => {
                const key = Object.keys(TASK_NAMES)[index];
                return data[key] || 0;
            });

            distributionChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.values(TASK_NAMES),
                    datasets: [{
                        data: values,
                        backgroundColor: CHART_COLORS.bg,
                        borderColor: CHART_COLORS.border,
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom', labels: { boxWidth: 12, font: { size: 10 } } }
                    }
                }
            });
        }

        function renderTrendChart(rawData) {
            const ctx = trendChartCanvas.getContext('2d');
            if (trendChartInstance) trendChartInstance.destroy();

            // 1. D√°tumok kigy≈±jt√©se √©s rendez√©se
            const dates = [...new Set(rawData.map(d => d.date))].sort();

            // 2. Datasetek el≈ëk√©sz√≠t√©se minden task t√≠pushoz
            const datasets = Object.keys(TASK_NAMES).map((taskKey, index) => {
                const data = dates.map(date => {
                    // Megkeress√ºk az adott naphoz tartoz√≥ √∂sszes rekordot (lehet t√∂bb v√°ros is)
                    const entries = rawData.filter(d => d.date === date);
                    // √ñsszeadjuk az √©rt√©keket
                    return entries.reduce((sum, entry) => sum + (entry[taskKey] || 0), 0);
                });

                return {
                    label: TASK_NAMES[taskKey],
                    data: data,
                    borderColor: CHART_COLORS.border[index],
                    backgroundColor: CHART_COLORS.bg[index],
                    tension: 0.3, // Kicsit sim√≠tott vonalak
                    fill: false
                };
            });

            trendChartInstance = new Chart(ctx, {
                type: 'line',
                data: { labels: dates, datasets: datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    plugins: { legend: { position: 'bottom' } },
                    scales: { y: { beginAtZero: true } }
                }
            });
        }

        function renderCityComparisonChart(rawData) {
            const ctx = comparisonChartCanvas.getContext('2d');
            if (comparisonChartInstance) comparisonChartInstance.destroy();

            const cities = ['gyor', 'pecs', 'kaposvar']; // Fix sorrend
            const cityLabels = cities.map(c => CITY_NAMES[c]);

            // Datasetek: Minden task t√≠pus egy oszlopcsoport lesz
            const datasets = Object.keys(TASK_NAMES).map((taskKey, index) => {
                const data = cities.map(city => {
                    // Adott v√°ros √∂sszes adata a lek√©rdezett id≈ëszakban
                    const cityEntries = rawData.filter(d => d.city === city);
                    return cityEntries.reduce((sum, entry) => sum + (entry[taskKey] || 0), 0);
                });

                return {
                    label: TASK_NAMES[taskKey],
                    data: data,
                    backgroundColor: CHART_COLORS.bg[index],
                    borderColor: CHART_COLORS.border[index],
                    borderWidth: 1
                };
            });

            comparisonChartInstance = new Chart(ctx, {
                type: 'bar', // Grouped bar alapb√≥l
                data: { labels: cityLabels, datasets: datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'bottom' } },
                    scales: { y: { beginAtZero: true } }
                }
            });
        }

        // FEJLESZT√âS: PDF EXPORT LOGIKA (Friss√≠tve)
        downloadPdfBtn.addEventListener('click', generatePDF);
        async function generatePDF() {
            if (typeof window.jspdf === 'undefined' || typeof window.html2canvas === 'undefined') { return; }

            const { jsPDF } = window.jspdf;
            const reportArea = document.getElementById('admin-report-area');
            const chartContainer = reportChartCanvas.parentElement;
            let tempImg = null;

            pdfLoadingMessage.textContent = "PDF k√©sz√≠t√©se, k√©rem v√°rjon...";

            try {
                // 1. Chart.js v√°sznak √°talak√≠t√°sa k√©pp√© (MIND)
                const chartCanvases = [reportChartCanvas, trendChartCanvas, distributionChartCanvas, comparisonChartCanvas];
                let tempImages = [];

                chartCanvases.forEach(canvas => {
                    if (canvas && canvas.offsetParent !== null) { // Csak ha l√°that√≥
                        // Chart instance keres√©se (kicsit hacky, de m≈±k√∂dik, ha tudjuk melyik melyik)
                        // Egyszer≈±bb: toBase64Image() h√≠v√°sa a v√°sznon l√©v≈ë instance-ra
                        let instance;
                        if (canvas.id === 'report-chart') instance = reportChartInstance;
                        else if (canvas.id === 'trend-chart') instance = trendChartInstance;
                        else if (canvas.id === 'distribution-chart') instance = distributionChartInstance;
                        else if (canvas.id === 'comparison-chart') instance = comparisonChartInstance;

                        if (instance) {
                            const imgData = instance.toBase64Image();
                            const tempImg = document.createElement('img');
                            tempImg.src = imgData;
                            // St√≠lus m√°sol√°sa a m√©rethez
                            tempImg.style.width = '100%';
                            tempImg.style.display = 'block';

                            // Csere a DOM-ban
                            canvas.style.display = 'none';
                            canvas.parentElement.appendChild(tempImg);
                            tempImages.push({ canvas: canvas, img: tempImg });
                        }
                    }
                });

                // 3. html2canvas futtat√°sa a statikus k√©ppel
                // FEJLESZT√âS: PDF Layout √©s M√©ret optimaliz√°l√°s
                // Ideiglenesen kik√©nyszer√≠tj√ºk a sz√©les n√©zetet, hogy ne mobil n√©zetet fot√≥zzon
                const originalWidth = reportArea.style.width;
                const originalMaxWidth = reportArea.style.maxWidth;
                reportArea.style.width = '1120px'; // Kb A4 ar√°ny (vagy desktop sz√©less√©g)
                reportArea.style.maxWidth = 'none';

                // Scale cs√∂kkent√©se √©s JPEG haszn√°lata a m√©ret miatt
                const canvas = await html2canvas(reportArea, { scale: 1.5, logging: false, useCORS: true, windowWidth: 1200 });
                const imgData = canvas.toDataURL('image/jpeg', 0.85); // PNG helyett JPEG 0.85 min≈ës√©g
                // Vissza√°ll√≠t√°s
                reportArea.style.width = originalWidth;
                reportArea.style.maxWidth = originalMaxWidth;

                const pdf = new jspdf.jsPDF('p', 'mm', 'a4');
                const imgProps = pdf.getImageProperties(imgData);
                const pdfWidth = pdf.internal.pageSize.getWidth();
                const pageHeight = pdf.internal.pageSize.getHeight();
                const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;

                let heightLeft = pdfHeight;
                let position = 0;

                // Els≈ë oldal hozz√°ad√°sa
                pdf.addImage(imgData, 'JPEG', 0, position, pdfWidth, pdfHeight);
                heightLeft -= pageHeight;

                // Tov√°bbi oldalak, ha nem f√©r ki egyre
                while (heightLeft > 0) {
                    position -= pageHeight; // Minden √∫j oldaln√°l feljebb toljuk a k√©pet
                    pdf.addPage();
                    pdf.addImage(imgData, 'JPEG', 0, position, pdfWidth, pdfHeight);
                    heightLeft -= pageHeight;
                }

                // F√°jln√©v gener√°l√°s
                const dateStr = new Date().toISOString().split('T')[0];
                pdf.save(`riport_${adminCityFilter.value}_${dateStr}.pdf`);

                pdfLoadingMessage.textContent = "Sikeres let√∂lt√©s!";

            } catch (error) {
                console.error("‚ùå PDF gener√°l√°si hiba:", error);
                pdfLoadingMessage.textContent = "Hiba a PDF k√©sz√≠t√©se k√∂zben.";
            } finally {
                // 5. Cleanup: Eredeti √°llapot vissza√°ll√≠t√°sa
                if (tempImages.length > 0) {
                    tempImages.forEach(item => {
                        if (item.img.parentNode) item.img.parentNode.removeChild(item.img);
                        item.canvas.style.display = 'block';
                    });
                }
                pdfLoadingMessage.textContent = "";
            }
        }

        // === CLEANUP APP UNLOAD-N√ÅL ===
        window.addEventListener('beforeunload', () => {
            stopPolling();
        });

        // === VISIBILITY CHANGE KEZEL√âS ===
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                console.log("üì± App h√°tt√©rbe ker√ºlt, polling folytat√≥dik...");
                // Polling folytat√≥dik...
            } else {
                console.log("üì± App el≈ët√©rbe ker√ºlt.");
                // Ha nem polling, ind√≠tsuk √∫jra
                if (!isPolling && isSupabaseReady) {
                    startPolling();
                }
                // Azonnali adatfriss√≠t√©s √©s v√°r√≥lista-feldolgoz√°s
                if (isSupabaseReady) {
                    pollData();
                }
            }
        });

        // === IND√çT√ÅS ===
        initApp();

    </script>
</body>

</html>